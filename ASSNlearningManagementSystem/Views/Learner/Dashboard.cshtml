@model ASSNlearningManagementSystem.Models.ViewLearnerModel

@{
    Layout = "_Layout";
    ViewData["Title"] = "Dashboard";
}

<head>
    <link rel="stylesheet" href="~/css/style.css" />
    <link rel="stylesheet" href="~/css/responsive.css" />
</head>

<main>
    <div class="container">
        <div class="dashboard-contents">

            <!-- Small Cards Section -->
            <div class="hero_section">
                <div class="number_card">
                    <div class="card1">
                        <div class="card1_left">
                            <img src="~/img/Policies.png" alt="Policies Icon" />
                        </div>
                        <div class="card1_right">
                            <h6>Courses Enrolled</h6>
                            <h1>@Model.Enrollments?.Count()</h1>
                        </div>
                    </div>
                    <div class="card2">
                        <div class="card2_left">
                            <img src="~/img/Claims.png" alt="Claims Icon" />
                        </div>
                        <div class="card2_right">
                            <h6>Total Courses</h6>
                            <h1>@Model.Courses?.Count()</h1>
                        </div>
                    </div>
                    <div class="card3">
                        <div class="card3_left">
                            <img src="~/img/Settlement.png" alt="Rating Icon" />
                        </div>
                        <div class="card3_right">
                            <h6>My Average Rating</h6>
                            <h1>
                                @(Model.AverageRating.HasValue? Model.AverageRating.Value.ToString("0.0") : "N/A") / 5
                            </h1>
                        </div>
                    </div>

                </div>
            </div>

            
            <div class="table_card" style="display: flex; flex-wrap: wrap; gap: 20px; margin-top: 20px;">

                <!-- Bar Chart-->
                <div class="motor_card_box" style="flex: 1 1 48%;">
                    <div class="details">
                        <div class="details-header">
                            <h3>Your Perfomance</h3>
                        </div>
                        <div class="chart-container" style="width:100%; height:400px;">
                            <canvas id="barChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Pie Chart -->
                <div class="motor_card_box" style="flex: 1 1 48%;">
                    <div class="details">
                        <div class="details-header">
                            <h3>Courses Available</h3>
                        </div>
                        <div class="chart-container" style="width:100%; height:400px;">
                            <canvas id="pieChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Enrollments Table -->
                <div class="motor_card_box" style="flex: 1 1 48%;">
                    <div class="details">
                        <div class="details-header">
                            <h3>Your Courses</h3>
                        </div>
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Course ID</th>
                                        <th>Completion Status</th>
                                        <th>Enrolled On</th>
                                        <th>Completed On</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var e in Model.Enrollments)
                                    {
                                        <tr>
                                            <td>@e.CourseId</td>
                                            <td>In Progress</td>
                                            <td>@e.EnrolledOn.ToString("yyyy-MM-dd")</td>
                                            <td>@(e.CompletedOn?.ToString("yyyy-MM-dd") ?? "N/A")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Exam Results Table -->
                <div class="motor_card_box" style="flex: 1 1 48%;">
                    <div class="details">
                        <div class="details-header">
                            <h3>Your Exam Results</h3>
                        </div>
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Exam ID</th>
                                        <th>Exam Title</th>
                                        <th>Max Marks</th>
                                        <th>Marks Obtained</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var result in Model.Results ?? new List<ASSNlearningManagementSystem.Models.ResultViewModel>())
                                    {
                                        <tr>
                                            <td>@result.ExamId</td>
                                            <td>@result.ExamTitle</td>
                                            <td>@result.MaxMarks</td>
                                            <td>@result.MarksObtained</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>

        </div>
    </div>
</main>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Labels for bar chart 
        const barLabels = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(
                    Model.Enrollments?.Select(e => e.CourseName ?? $"Course {e.CourseId}") ?? new List<string>()
            ));

    
    const enrollmentCounts = {};
    barLabels.forEach(function(course) {
        enrollmentCounts[course] = (enrollmentCounts[course] || 0) + 1;
    });

        const uniqueLabels = Object.keys(enrollmentCounts);
        const barData = Object.values(enrollmentCounts);

        // Pie chart data
        const pieLabels = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(
                Model.Courses?.Select(c => c.CourseName) ?? new List<string>()
        ));
    const pieData = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(
                Model.Courses?.Select(c => 1) ?? new List<int>()
        ));

    //  bar chart
    new Chart(document.getElementById('barChart'), {
             type: 'bar',
             data: {
                 labels: barLabels,
                 datasets: [{
                     label: 'Marks Obtained',
                     data: barData,
                     backgroundColor: '#4e73df'
                 }]
             },
             options: {
                 responsive: true,
                 plugins: {
                     legend: { display: false },
                     tooltip: {
                         callbacks: {
                             label: context => `Marks: ${context.parsed.y}`
                         }
                     }
                 },
                 scales: {
                     y: {
                         beginAtZero: true,
                         title: { display: true, text: 'Marks Obtained' }
                     },
                     x: {
                         title: { display: true, text: 'Exam Title' }
                     }
                 }
             }
         });

        //  pie chart
        new Chart(document.getElementById('pieChart'), {
            type: 'pie',
            data: {
                labels: pieLabels,
                datasets: [{
                    label: 'Courses',
                    data: pieData,
                    backgroundColor: [
                        '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'
                    ]
                }]
            }
        });
    </script>
}
